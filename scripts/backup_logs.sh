#!/bin/bash
#
# backup_logs.sh - –ë—ç–∫–∞–ø –ª–æ–≥–æ–≤ Docker —Å–µ—Ä–≤–∏—Å–æ–≤ —Å timestamp
#
# –û–ø–∏—Å–∞–Ω–∏–µ:
#   –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ª–æ–≥–∏ –≤—Å–µ—Ö Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –≤ —Ñ–∞–π–ª—ã —Å timestamp.
#   –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—Ä—Ö–∏–≤–∞—Ü–∏—é –≤ tar.gz –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞.
#   –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∞—Ä—Ö–∏–≤–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).
#   –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è –±—ç–∫–∞–ø–∞.
#
# –ê–≤—Ç–æ—Ä: Denis E.
# –î–∞—Ç–∞: 2025-12-23
# –í–µ—Ä—Å–∏—è: 1.0
#
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   ./backup_logs.sh                          # –ë—ç–∫–∞–ø –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
#   ./backup_logs.sh --service=backend        # –ë—ç–∫–∞–ø —Ç–æ–ª—å–∫–æ backend
#   ./backup_logs.sh --archive                # –°–æ–∑–¥–∞—Ç—å tar.gz –∞—Ä—Ö–∏–≤
#   ./backup_logs.sh --cleanup-days=7         # –£–¥–∞–ª–∏—Ç—å –∞—Ä—Ö–∏–≤—ã —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
#   ./backup_logs.sh --lines=1000             # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 —Å—Ç—Ä–æ–∫
#   ./backup_logs.sh --help                   # –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
#
# –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
#   - docker-compose —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
#   - –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è logs/ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (—Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
#   - tar —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏)
#

# ============================================================================
# –¶–í–ï–¢–û–í–´–ï –ö–û–î–´ –î–õ–Ø –¢–ï–†–ú–ò–ù–ê–õ–ê
# ============================================================================

RED='\033[0;31m'      # –ö—Ä–∞—Å–Ω—ã–π - –¥–ª—è –æ—à–∏–±–æ–∫
GREEN='\033[0;32m'    # –ó–µ–ª—ë–Ω—ã–π - –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
YELLOW='\033[1;33m'   # –ñ—ë–ª—Ç—ã–π - –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
CYAN='\033[0;36m'     # –ì–æ–ª—É–±–æ–π - –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
BLUE='\033[0;34m'     # –°–∏–Ω–∏–π - –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
NC='\033[0m'          # No Color - —Å–±—Ä–æ—Å —Ü–≤–µ—Ç–∞

# ============================================================================
# –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ
# ============================================================================

BACKUP_DIR="logs/backups"        # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±—ç–∫–∞–ø–æ–≤
SPECIFIC_SERVICE=""              # –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å (–ø—É—Å—Ç–æ = –≤—Å–µ)
CREATE_ARCHIVE=false             # –°–æ–∑–¥–∞–≤–∞—Ç—å tar.gz –∞—Ä—Ö–∏–≤
CLEANUP_DAYS=0                   # –£–¥–∞–ª—è—Ç—å –∞—Ä—Ö–∏–≤—ã —Å—Ç–∞—Ä—à–µ N –¥–Ω–µ–π (0 = –Ω–µ —É–¥–∞–ª—è—Ç—å)
LOG_LINES=0                      # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ (0 = –≤—Å–µ –ª–æ–≥–∏)
DRY_RUN=false                    # –†–µ–∂–∏–º dry-run

# Timestamp –¥–ª—è –∏–º—ë–Ω —Ñ–∞–π–ª–æ–≤
# $(date +%Y%m%d_%H%M%S) - YYYYMMDD_HHMMSS —Ñ–æ—Ä–º–∞—Ç
# –ü—Ä–∏–º–µ—Ä: 20251223_143052
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è –±—ç–∫–∞–ø–∞
SERVICES=("postgres" "backend")

# –°—á—ë—Ç—á–∏–∫–∏
TOTAL_BACKUPS=0
SUCCESSFUL_BACKUPS=0
FAILED_BACKUPS=0

# ============================================================================
# –§–£–ù–ö–¶–ò–Ø: –ü–û–ö–ê–ó–ê–¢–¨ –°–ü–†–ê–í–ö–£
# ============================================================================

show_usage() {
    echo -e "${CYAN}===========================================================${NC}"
    echo -e "${CYAN}  backup_logs.sh - –ë—ç–∫–∞–ø –ª–æ–≥–æ–≤ Docker —Å–µ—Ä–≤–∏—Å–æ–≤${NC}"
    echo -e "${CYAN}===========================================================${NC}"
    echo ""
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [OPTIONS]"
    echo ""
    echo "–û–ø—Ü–∏–∏:"
    echo "  --service=NAME       –ë—ç–∫–∞–ø —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞"
    echo "  --archive            –°–æ–∑–¥–∞—Ç—å tar.gz –∞—Ä—Ö–∏–≤ –ø–æ—Å–ª–µ –±—ç–∫–∞–ø–∞"
    echo "  --cleanup-days=N     –£–¥–∞–ª–∏—Ç—å –∞—Ä—Ö–∏–≤—ã —Å—Ç–∞—Ä—à–µ N –¥–Ω–µ–π"
    echo "  --lines=N            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤"
    echo "  --dir=PATH           –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –±—ç–∫–∞–ø–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: logs/backups)"
    echo "  --dry-run            –ü–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ –±–µ–∑ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –±—ç–∫–∞–ø–∞"
    echo "  --help               –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
    echo ""
    echo "–ü—Ä–∏–º–µ—Ä—ã:"
    echo "  $0                               # –ë—ç–∫–∞–ø –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
    echo "  $0 --service=backend             # –ë—ç–∫–∞–ø —Ç–æ–ª—å–∫–æ backend"
    echo "  $0 --archive                     # –ë—ç–∫–∞–ø –≤—Å–µ—Ö + —Å–æ–∑–¥–∞—Ç—å –∞—Ä—Ö–∏–≤"
    echo "  $0 --archive --cleanup-days=7    # –ë—ç–∫–∞–ø + —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∞—Ä—Ö–∏–≤—ã"
    echo "  $0 --lines=1000                  # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 —Å—Ç—Ä–æ–∫"
    echo "  $0 --dry-run                     # –ü–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ"
    echo ""
    echo "–§–æ—Ä–º–∞—Ç –∏–º—ë–Ω —Ñ–∞–π–ª–æ–≤:"
    echo "  logs/backups/backend_YYYYMMDD_HHMMSS.log"
    echo "  logs/backups/backup_YYYYMMDD_HHMMSS.tar.gz (–ø—Ä–∏ --archive)"
    echo ""
}

# ============================================================================
# –£–¢–ò–õ–ò–¢–´
# ============================================================================

print_ok() {
    echo -e "${GREEN}‚úì${NC} $1"
}

print_fail() {
    echo -e "${RED}‚úó${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}‚ö†${NC} $1"
}

print_info() {
    echo -e "${BLUE}‚Ñπ${NC} $1"
}

# ============================================================================
# –§–£–ù–ö–¶–ò–Ø: –ü–†–û–í–ï–†–ö–ê –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô
# ============================================================================

check_dependencies() {
    echo -e "${CYAN}–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"

    local missing_deps=0

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ docker-compose
    if ! command -v docker-compose &> /dev/null; then
        print_fail "docker-compose –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        ((missing_deps++))
    else
        print_ok "docker-compose —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ tar (–¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏)
    if [ "$CREATE_ARCHIVE" = true ]; then
        if ! command -v tar &> /dev/null; then
            print_fail "tar –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–Ω—É–∂–µ–Ω –¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏)"
            ((missing_deps++))
        else
            print_ok "tar —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        fi
    fi

    echo ""

    if [ $missing_deps -gt 0 ]; then
        echo -e "${RED}–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–æ–≤–∞.${NC}"
        exit 1
    fi
}

# ============================================================================
# –§–£–ù–ö–¶–ò–Ø: –°–û–ó–î–ê–ù–ò–ï –î–ò–†–ï–ö–¢–û–†–ò–ò –î–õ–Ø –ë–≠–ö–ê–ü–û–í
# ============================================================================

create_backup_dir() {
    echo -e "${CYAN}–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –±—ç–∫–∞–ø–æ–≤...${NC}"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    # -d –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ —ç—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
    if [ ! -d "$BACKUP_DIR" ]; then
        if [ "$DRY_RUN" = true ]; then
            print_info "DRY-RUN: –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $BACKUP_DIR"
        else
            # mkdir -p —Å–æ–∑–¥–∞—ë—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤–∫–ª—é—á–∞—è —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ
            # –ü—Ä–∏–º–µ—Ä: logs/backups —Å–æ–∑–¥–∞—Å—Ç logs/ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç, –∑–∞—Ç–µ–º backups/
            mkdir -p "$BACKUP_DIR"

            if [ $? -eq 0 ]; then
                print_ok "–°–æ–∑–¥–∞–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $BACKUP_DIR"
            else
                print_fail "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é: $BACKUP_DIR"
                exit 1
            fi
        fi
    else
        print_ok "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: $BACKUP_DIR"
    fi

    echo ""
}

# ============================================================================
# –§–£–ù–ö–¶–ò–Ø: –ë–≠–ö–ê–ü –õ–û–ì–û–í –û–î–ù–û–ì–û –°–ï–†–í–ò–°–ê
# ============================================================================

backup_service() {
    local service=$1
    ((TOTAL_BACKUPS++))

    echo -e "${CYAN}–ë—ç–∫–∞–ø –ª–æ–≥–æ–≤: $service${NC}"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω
    # docker-compose ps -q SERVICE –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç ID –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    local container_id=$(docker-compose ps -q "$service" 2>/dev/null)

    if [ -z "$container_id" ]; then
        print_warning "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä $service –Ω–µ –∑–∞–ø—É—â–µ–Ω - –ø—Ä–æ–ø—É—â–µ–Ω"
        ((FAILED_BACKUPS++))
        return 1
    fi

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –±—ç–∫–∞–ø–∞
    # –§–æ—Ä–º–∞—Ç: SERVICE_YYYYMMDD_HHMMSS.log
    # –ü—Ä–∏–º–µ—Ä: backend_20251223_143052.log
    local backup_file="${BACKUP_DIR}/${service}_${TIMESTAMP}.log"

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É docker-compose logs
    # --no-color - –±–µ–∑ —Ü–≤–µ—Ç–æ–≤—ã—Ö ANSI –∫–æ–¥–æ–≤
    # --timestamps - –¥–æ–±–∞–≤–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –∫ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ
    # --tail=N - —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å—Ç—Ä–æ–∫ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ)

    local logs_cmd="docker-compose logs --no-color --timestamps"

    # –î–æ–±–∞–≤–ª—è–µ–º --tail –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ
    if [ $LOG_LINES -gt 0 ]; then
        logs_cmd="$logs_cmd --tail=$LOG_LINES"
    fi

    # –î–æ–±–∞–≤–ª—è–µ–º –∏–º—è —Å–µ—Ä–≤–∏—Å–∞
    logs_cmd="$logs_cmd $service"

    if [ "$DRY_RUN" = true ]; then
        print_info "DRY-RUN: $logs_cmd > $backup_file"
        ((SUCCESSFUL_BACKUPS++))
    else
        # –í—ã–ø–æ–ª–Ω—è–µ–º –±—ç–∫–∞–ø
        # > –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç stdout –≤ —Ñ–∞–π–ª (–ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç)
        # 2>&1 –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç stderr –≤ stdout
        $logs_cmd > "$backup_file" 2>&1

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å
        if [ $? -eq 0 ] && [ -f "$backup_file" ]; then
            # stat -f%z (macOS) –∏–ª–∏ stat -c%s (Linux) - —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ –±–∞–π—Ç–∞—Ö
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º ls -lh –¥–ª—è –∫—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ—Å—Ç–∏
            local file_size=$(ls -lh "$backup_file" | awk '{print $5}')
            print_ok "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: $backup_file ($file_size)"
            ((SUCCESSFUL_BACKUPS++))
        else
            print_fail "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: $backup_file"
            ((FAILED_BACKUPS++))
            return 1
        fi
    fi
}

# ============================================================================
# –§–£–ù–ö–¶–ò–Ø: –°–û–ó–î–ê–ù–ò–ï –ê–†–•–ò–í–ê
# ============================================================================

create_tar_archive() {
    echo ""
    echo -e "${CYAN}===========================================================${NC}"
    echo -e "${CYAN}  –°–æ–∑–¥–∞–Ω–∏–µ tar.gz –∞—Ä—Ö–∏–≤–∞${NC}"
    echo -e "${CYAN}===========================================================${NC}"
    echo ""

    # –ò–º—è –∞—Ä—Ö–∏–≤–∞: backup_YYYYMMDD_HHMMSS.tar.gz
    local archive_name="backup_${TIMESTAMP}.tar.gz"
    local archive_path="${BACKUP_DIR}/${archive_name}"

    # –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏
    # –í—Å–µ .log —Ñ–∞–π–ª—ã —Å —Ç–µ–∫—É—â–∏–º timestamp
    local files_pattern="${BACKUP_DIR}/*_${TIMESTAMP}.log"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å —Ñ–∞–π–ª—ã –¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏
    local files_count=$(ls $files_pattern 2>/dev/null | wc -l)

    if [ $files_count -eq 0 ]; then
        print_warning "–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏"
        return 1
    fi

    if [ "$DRY_RUN" = true ]; then
        print_info "DRY-RUN: –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ $archive_name —Å $files_count —Ñ–∞–π–ª–∞–º–∏"
        return 0
    fi

    echo -e "${BLUE}–§–∞–π–ª—ã –¥–ª—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏: $files_count${NC}"

    # –°–æ–∑–¥–∞—ë–º tar.gz –∞—Ä—Ö–∏–≤
    # tar - –∞—Ä—Ö–∏–≤–∞—Ç–æ—Ä
    # -c (--create) - —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∞—Ä—Ö–∏–≤
    # -z (--gzip) - —Å–∂–∞—Ç—å —á–µ—Ä–µ–∑ gzip
    # -f (--file) - –∏–º—è —Ñ–∞–π–ª–∞ –∞—Ä—Ö–∏–≤–∞
    # -v (--verbose) - –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å

    tar -czf "$archive_path" $files_pattern 2>/dev/null

    if [ $? -eq 0 ] && [ -f "$archive_path" ]; then
        local archive_size=$(ls -lh "$archive_path" | awk '{print $5}')
        print_ok "–ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: $archive_name ($archive_size)"

        # –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ .log —Ñ–∞–π–ª—ã –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏
        echo -e "${BLUE}–£–¥–∞–ª–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω—ã—Ö .log —Ñ–∞–π–ª–æ–≤...${NC}"
        rm -f $files_pattern

        if [ $? -eq 0 ]; then
            print_ok "–ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã"
        else
            print_warning "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã"
        fi
    else
        print_fail "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞—Ä—Ö–∏–≤–∞"
        return 1
    fi

    echo ""
}

# ============================================================================
# –§–£–ù–ö–¶–ò–Ø: –û–ß–ò–°–¢–ö–ê –°–¢–ê–†–´–• –ê–†–•–ò–í–û–í
# ============================================================================

cleanup_old_backups() {
    echo ""
    echo -e "${CYAN}===========================================================${NC}"
    echo -e "${CYAN}  –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∞—Ä—Ö–∏–≤–æ–≤${NC}"
    echo -e "${CYAN}===========================================================${NC}"
    echo ""

    if [ $CLEANUP_DAYS -le 0 ]; then
        print_info "–û—á–∏—Å—Ç–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞ (--cleanup-days –Ω–µ —É–∫–∞–∑–∞–Ω)"
        return 0
    fi

    echo -e "${BLUE}–ü–æ–∏—Å–∫ –∞—Ä—Ö–∏–≤–æ–≤ —Å—Ç–∞—Ä—à–µ $CLEANUP_DAYS –¥–Ω–µ–π...${NC}"

    # find - –ø–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤
    # $BACKUP_DIR - –≥–¥–µ –∏—Å–∫–∞—Ç—å
    # -name "backup_*.tar.gz" - –ø–∞—Ç—Ç–µ—Ä–Ω –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
    # -type f - —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã
    # -mtime +$CLEANUP_DAYS - –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã –±–æ–ª–µ–µ —á–µ–º N –¥–Ω–µ–π –Ω–∞–∑–∞–¥
    #   +7 = —Å—Ç—Ä–æ–≥–æ –±–æ–ª—å—à–µ 7 –¥–Ω–µ–π (8, 9, 10...)

    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤
    local old_files_count=$(find "$BACKUP_DIR" -name "backup_*.tar.gz" -type f -mtime +$CLEANUP_DAYS 2>/dev/null | wc -l)

    if [ $old_files_count -eq 0 ]; then
        print_ok "–°—Ç–∞—Ä—ã—Ö –∞—Ä—Ö–∏–≤–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
        return 0
    fi

    echo -e "${YELLOW}–ù–∞–π–¥–µ–Ω–æ —Å—Ç–∞—Ä—ã—Ö –∞—Ä—Ö–∏–≤–æ–≤: $old_files_count${NC}"
    echo ""

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
    echo -e "${CYAN}–°–ø–∏—Å–æ–∫ –∞—Ä—Ö–∏–≤–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:${NC}"
    find "$BACKUP_DIR" -name "backup_*.tar.gz" -type f -mtime +$CLEANUP_DAYS -ls 2>/dev/null
    echo ""

    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä
    local total_size=$(find "$BACKUP_DIR" -name "backup_*.tar.gz" -type f -mtime +$CLEANUP_DAYS -exec du -ch {} + 2>/dev/null | tail -1 | awk '{print $1}')
    echo -e "${YELLOW}–û–±—â–∏–π —Ä–∞–∑–º–µ—Ä –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è: $total_size${NC}"
    echo ""

    if [ "$DRY_RUN" = true ]; then
        print_info "DRY-RUN: –ë—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ $old_files_count –∞—Ä—Ö–∏–≤–æ–≤ ($total_size)"
    else
        # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã
        find "$BACKUP_DIR" -name "backup_*.tar.gz" -type f -mtime +$CLEANUP_DAYS -delete 2>/dev/null

        if [ $? -eq 0 ]; then
            print_ok "–£–¥–∞–ª–µ–Ω–æ $old_files_count –∞—Ä—Ö–∏–≤–æ–≤ ($total_size)"
        else
            print_fail "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞—Ä—Ö–∏–≤–æ–≤"
            return 1
        fi
    fi

    echo ""
}

# ============================================================================
# –§–£–ù–ö–¶–ò–Ø: –ò–¢–û–ì–û–í–´–ô –û–¢–ß–Å–¢
# ============================================================================

show_summary() {
    echo -e "${CYAN}===========================================================${NC}"
    echo -e "${CYAN}  –ò–¢–û–ì–û–í–´–ô –û–¢–ß–Å–¢${NC}"
    echo -e "${CYAN}===========================================================${NC}"
    echo ""

    echo -e "${BLUE}Timestamp:            $TIMESTAMP${NC}"
    echo -e "${BLUE}–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –±—ç–∫–∞–ø–æ–≤:   $BACKUP_DIR${NC}"
    echo -e "${BLUE}–í—Å–µ–≥–æ —Å–µ—Ä–≤–∏—Å–æ–≤:       $TOTAL_BACKUPS${NC}"
    echo -e "${GREEN}–£—Å–ø–µ—à–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤:     $SUCCESSFUL_BACKUPS${NC}"
    echo -e "${RED}–ü—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö:          $FAILED_BACKUPS${NC}"
    echo ""

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±—ç–∫–∞–ø–æ–≤
    if [ "$DRY_RUN" = false ]; then
        echo -e "${CYAN}–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±—ç–∫–∞–ø–æ–≤:${NC}"
        ls -lh "$BACKUP_DIR" | grep "$TIMESTAMP" || echo "  (–Ω–µ—Ç —Ñ–∞–π–ª–æ–≤ —Å —Ç–µ–∫—É—â–∏–º timestamp)"
        echo ""
    fi

    if [ $FAILED_BACKUPS -eq 0 ]; then
        echo -e "${GREEN}‚úì –í–°–ï –ë–≠–ö–ê–ü–´ –í–´–ü–û–õ–ù–ï–ù–´ –£–°–ü–ï–®–ù–û${NC}"
        exit 0
    else
        echo -e "${YELLOW}‚ö† –ù–ï–ö–û–¢–û–†–´–ï –ë–≠–ö–ê–ü–´ –ó–ê–í–ï–†–®–ò–õ–ò–°–¨ –° –û–®–ò–ë–ö–ê–ú–ò${NC}"
        exit 1
    fi
}

# ============================================================================
# –ü–ê–†–°–ò–ù–ì –ê–†–ì–£–ú–ï–ù–¢–û–í –ö–û–ú–ê–ù–î–ù–û–ô –°–¢–†–û–ö–ò
# ============================================================================

for arg in "$@"; do
    case $arg in
        --service=*)
            SPECIFIC_SERVICE="${arg#--service=}"
            ;;
        --archive)
            CREATE_ARCHIVE=true
            ;;
        --cleanup-days=*)
            CLEANUP_DAYS="${arg#--cleanup-days=}"
            ;;
        --lines=*)
            LOG_LINES="${arg#--lines=}"
            ;;
        --dir=*)
            BACKUP_DIR="${arg#--dir=}"
            ;;
        --dry-run)
            DRY_RUN=true
            ;;
        --help|-h)
            show_usage
            exit 0
            ;;
        *)
            echo -e "${RED}–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä: $arg${NC}"
            echo ""
            show_usage
            exit 1
            ;;
    esac
done

# ============================================================================
# –í–ê–õ–ò–î–ê–¶–ò–Ø –ü–ê–†–ê–ú–ï–¢–†–û–í
# ============================================================================

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ CLEANUP_DAYS - —ç—Ç–æ —á–∏—Å–ª–æ
if ! [[ $CLEANUP_DAYS =~ ^[0-9]+$ ]]; then
    echo -e "${RED}–û—à–∏–±–∫–∞: --cleanup-days –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º${NC}"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ LOG_LINES - —ç—Ç–æ —á–∏—Å–ª–æ
if ! [[ $LOG_LINES =~ ^[0-9]+$ ]]; then
    echo -e "${RED}–û—à–∏–±–∫–∞: --lines –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º${NC}"
    exit 1
fi

# ============================================================================
# –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê
# ============================================================================

# –ü–µ—á–∞—Ç–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
echo ""
echo -e "${CYAN}‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì${NC}"
echo -e "${CYAN}‚îÉ  üíæ –ë—ç–∫–∞–ø –ª–æ–≥–æ–≤ Docker —Å–µ—Ä–≤–∏—Å–æ–≤ - DockerKube          ‚îÉ${NC}"
echo -e "${CYAN}‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ${NC}"
echo ""
echo -e "${BLUE}–î–∞—Ç–∞ –∑–∞–ø—É—Å–∫–∞: $(date '+%Y-%m-%d %H:%M:%S')${NC}"
echo -e "${BLUE}Timestamp: $TIMESTAMP${NC}"
if [ "$DRY_RUN" = true ]; then
    echo -e "${YELLOW}–†–µ–∂–∏–º: DRY-RUN (–±–µ–∑ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –±—ç–∫–∞–ø–∞)${NC}"
fi
if [ -n "$SPECIFIC_SERVICE" ]; then
    echo -e "${BLUE}–°–µ—Ä–≤–∏—Å: $SPECIFIC_SERVICE${NC}"
fi
if [ $LOG_LINES -gt 0 ]; then
    echo -e "${BLUE}–°—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤: –ø–æ—Å–ª–µ–¥–Ω–∏–µ $LOG_LINES${NC}"
else
    echo -e "${BLUE}–°—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤: –≤—Å–µ${NC}"
fi
echo ""

# –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –±—ç–∫–∞–ø
check_dependencies
create_backup_dir

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è –±—ç–∫–∞–ø–∞
if [ -n "$SPECIFIC_SERVICE" ]; then
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Ä–≤–∏—Å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if docker-compose ps --services | grep -q "^${SPECIFIC_SERVICE}$"; then
        SERVICES=("$SPECIFIC_SERVICE")
    else
        echo -e "${RED}–û—à–∏–±–∫–∞: –°–µ—Ä–≤–∏—Å '$SPECIFIC_SERVICE' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ docker-compose.yml${NC}"
        exit 1
    fi
fi

# –í—ã–ø–æ–ª–Ω—è–µ–º –±—ç–∫–∞–ø –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
echo -e "${CYAN}===========================================================${NC}"
echo -e "${CYAN}  –ë—ç–∫–∞–ø –ª–æ–≥–æ–≤ —Å–µ—Ä–≤–∏—Å–æ–≤${NC}"
echo -e "${CYAN}===========================================================${NC}"
echo ""

for service in "${SERVICES[@]}"; do
    backup_service "$service"
    echo ""
done

# –°–æ–∑–¥–∞—ë–º –∞—Ä—Ö–∏–≤ –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ
if [ "$CREATE_ARCHIVE" = true ]; then
    create_tar_archive
fi

# –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∞—Ä—Ö–∏–≤—ã –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ
if [ $CLEANUP_DAYS -gt 0 ]; then
    cleanup_old_backups
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç
show_summary
