#!/bin/bash
#
# monitoring_script.sh - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è Docker —Å–µ—Ä–≤–∏—Å–æ–≤
#
# –û–ø–∏—Å–∞–Ω–∏–µ:
#   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö Docker —Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ DockerKube.
#   –í—ã–ø–æ–ª–Ω—è–µ—Ç health checks –¥–ª—è PostgreSQL –∏ Backend API.
#   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ (CPU/RAM).
#   –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–≤–µ–∂–∏—Ö –æ—à–∏–±–æ–∫.
#   –í—ã–≤–æ–¥–∏—Ç –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã.
#
# –ê–≤—Ç–æ—Ä: Denis E.
# –î–∞—Ç–∞: 2025-12-23
# –í–µ—Ä—Å–∏—è: 1.0
#
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   ./monitoring_script.sh              # –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
#   ./monitoring_script.sh --quick      # –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–±–µ–∑ –ª–æ–≥–æ–≤)
#   ./monitoring_script.sh --service=backend  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ backend
#   ./monitoring_script.sh --help       # –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
#
# –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
#   - docker –∏ docker-compose —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
#   - curl —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–¥–ª—è HTTP –ø—Ä–æ–≤–µ—Ä–æ–∫)
#   - –ó–∞–ø—É—Å–∫–∞—Ç—å –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ DockerKube
#

# ============================================================================
# –¶–í–ï–¢–û–í–´–ï –ö–û–î–´ –î–õ–Ø –¢–ï–†–ú–ò–ù–ê–õ–ê
# ============================================================================

RED='\033[0;31m'      # –ö—Ä–∞—Å–Ω—ã–π - –¥–ª—è –æ—à–∏–±–æ–∫ –∏ failed –ø—Ä–æ–≤–µ—Ä–æ–∫
GREEN='\033[0;32m'    # –ó–µ–ª—ë–Ω—ã–π - –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
YELLOW='\033[1;33m'   # –ñ—ë–ª—Ç—ã–π - –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
CYAN='\033[0;36m'     # –ì–æ–ª—É–±–æ–π - –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
BLUE='\033[0;34m'     # –°–∏–Ω–∏–π - –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
NC='\033[0m'          # No Color - —Å–±—Ä–æ—Å —Ü–≤–µ—Ç–∞

# ============================================================================
# –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ
# ============================================================================

QUICK_MODE=false              # –ë—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–æ–≤)
SPECIFIC_SERVICE=""           # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
DOCKER_COMPOSE_FILE="docker-compose.yml"  # –ü—É—Ç—å –∫ docker-compose —Ñ–∞–π–ª—É
BACKEND_URL="http://localhost:8000"       # URL Backend API
LOG_LINES=50                  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

# –°—á—ë—Ç—á–∏–∫–∏ –¥–ª—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ—Ç—á—ë—Ç–∞
TOTAL_CHECKS=0
PASSED_CHECKS=0
FAILED_CHECKS=0

# ============================================================================
# –§–£–ù–ö–¶–ò–Ø: –ü–û–ö–ê–ó–ê–¢–¨ –°–ü–†–ê–í–ö–£
# ============================================================================

show_usage() {
    echo -e "${CYAN}===========================================================${NC}"
    echo -e "${CYAN}  monitoring_script.sh - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Docker —Å–µ—Ä–≤–∏—Å–æ–≤${NC}"
    echo -e "${CYAN}===========================================================${NC}"
    echo ""
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [OPTIONS]"
    echo ""
    echo "–û–ø—Ü–∏–∏:"
    echo "  --quick              –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–±–µ–∑ –∞–Ω–∞–ª–∏–∑–∞ –ª–æ–≥–æ–≤)"
    echo "  --service=NAME       –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å"
    echo "  --logs=N             –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 50)"
    echo "  --help               –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
    echo ""
    echo "–ü—Ä–∏–º–µ—Ä—ã:"
    echo "  $0                         # –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
    echo "  $0 --quick                 # –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (—Å—Ç–∞—Ç—É—Å + health)"
    echo "  $0 --service=backend       # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–ª—å–∫–æ backend"
    echo "  $0 --logs=100              # –ê–Ω–∞–ª–∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 100 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤"
    echo ""
    echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ —Å–µ—Ä–≤–∏—Å—ã:"
    echo "  - postgres    PostgreSQL –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö"
    echo "  - backend     FastAPI backend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
    echo ""
}

# ============================================================================
# –£–¢–ò–õ–ò–¢–´
# ============================================================================

# –£–≤–µ–ª–∏—á–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ –ø—Ä–æ–≤–µ—Ä–æ–∫
increment_total() {
    ((TOTAL_CHECKS++))
}

# –û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–∞–∫ —É—Å–ø–µ—à–Ω—É—é
mark_passed() {
    ((PASSED_CHECKS++))
}

# –û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–∞–∫ –ø—Ä–æ–≤–∞–ª—å–Ω—É—é
mark_failed() {
    ((FAILED_CHECKS++))
}

# –ü–µ—á–∞—Ç—å —Å—Ç–∞—Ç—É—Å–∞ OK
print_ok() {
    echo -e "${GREEN}‚úì${NC} $1"
}

# –ü–µ—á–∞—Ç—å —Å—Ç–∞—Ç—É—Å–∞ FAIL
print_fail() {
    echo -e "${RED}‚úó${NC} $1"
}

# –ü–µ—á–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
print_warning() {
    echo -e "${YELLOW}‚ö†${NC} $1"
}

# –ü–µ—á–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
print_info() {
    echo -e "${BLUE}‚Ñπ${NC} $1"
}

# ============================================================================
# –§–£–ù–ö–¶–ò–Ø: –ü–†–û–í–ï–†–ö–ê –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô
# ============================================================================

check_dependencies() {
    echo -e "${CYAN}–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"

    local missing_deps=0

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ docker
    if ! command -v docker &> /dev/null; then
        print_fail "docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        ((missing_deps++))
    else
        print_ok "docker —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ docker-compose
    if ! command -v docker-compose &> /dev/null; then
        print_fail "docker-compose –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        ((missing_deps++))
    else
        print_ok "docker-compose —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ curl
    if ! command -v curl &> /dev/null; then
        print_fail "curl –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–Ω—É–∂–µ–Ω –¥–ª—è HTTP –ø—Ä–æ–≤–µ—Ä–æ–∫)"
        ((missing_deps++))
    else
        print_ok "curl —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ docker-compose.yml
    if [ ! -f "$DOCKER_COMPOSE_FILE" ]; then
        print_fail "–§–∞–π–ª $DOCKER_COMPOSE_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω"
        print_warning "–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞"
        ((missing_deps++))
    else
        print_ok "–§–∞–π–ª $DOCKER_COMPOSE_FILE –Ω–∞–π–¥–µ–Ω"
    fi

    echo ""

    if [ $missing_deps -gt 0 ]; then
        echo -e "${RED}–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç $missing_deps –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–æ–≤–∞.${NC}"
        exit 1
    fi
}

# ============================================================================
# –§–£–ù–ö–¶–ò–Ø: –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê –ö–û–ù–¢–ï–ô–ù–ï–†–û–í
# ============================================================================

check_containers() {
    echo -e "${CYAN}===========================================================${NC}"
    echo -e "${CYAN}  1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤${NC}"
    echo -e "${CYAN}===========================================================${NC}"
    echo ""

    # docker-compose ps - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
    # –ö–æ–º–∞–Ω–¥–∞ –≤—ã–≤–æ–¥–∏—Ç —Ç–∞–±–ª–∏—Ü—É: Name, Command, State, Ports

    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
    # docker-compose ps -q –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
    local running_containers=$(docker-compose ps -q 2>/dev/null | wc -l)

    # docker-compose ps --services –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –∏–∑ docker-compose.yml
    local total_services=$(docker-compose ps --services 2>/dev/null | wc -l)

    echo -e "${BLUE}–í—Å–µ–≥–æ —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ docker-compose.yml: $total_services${NC}"
    echo -e "${BLUE}–ó–∞–ø—É—â–µ–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: $running_containers${NC}"
    echo ""

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
    echo -e "${CYAN}–î–µ—Ç–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å:${NC}"
    docker-compose ps
    echo ""

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –æ—Ç–¥–µ–ª—å–Ω–æ
    # --services –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫: postgres, backend, tests
    for service in $(docker-compose ps --services); do
        increment_total

        # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
        if [ -n "$SPECIFIC_SERVICE" ] && [ "$service" != "$SPECIFIC_SERVICE" ]; then
            continue
        fi

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        # docker-compose ps -q SERVICE –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω)
        local container_id=$(docker-compose ps -q "$service" 2>/dev/null)

        if [ -n "$container_id" ]; then
            # docker inspect –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –≤ JSON
            # --format '{{.State.Status}}' –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å
            local status=$(docker inspect --format='{{.State.Status}}' "$container_id" 2>/dev/null)

            if [ "$status" = "running" ]; then
                print_ok "–°–µ—Ä–≤–∏—Å $service: Running"
                mark_passed
            else
                print_fail "–°–µ—Ä–≤–∏—Å $service: $status (–Ω–µ running)"
                mark_failed
            fi
        else
            print_fail "–°–µ—Ä–≤–∏—Å $service: Not running (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω)"
            mark_failed
        fi
    done

    echo ""
}

# ============================================================================
# –§–£–ù–ö–¶–ò–Ø: HEALTH CHECK POSTGRESQL
# ============================================================================

check_postgres() {
    echo -e "${CYAN}===========================================================${NC}"
    echo -e "${CYAN}  2. Health Check - PostgreSQL${NC}"
    echo -e "${CYAN}===========================================================${NC}"
    echo ""

    increment_total

    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–∏—Å
    if [ -n "$SPECIFIC_SERVICE" ] && [ "$SPECIFIC_SERVICE" != "postgres" ]; then
        print_info "–ü—Ä–æ–ø—É—â–µ–Ω–æ (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ $SPECIFIC_SERVICE)"
        echo ""
        return
    fi

    # pg_isready - —É—Ç–∏–ª–∏—Ç–∞ PostgreSQL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
    # -h localhost - —Ö–æ—Å—Ç
    # -p 5432 - –ø–æ—Ä—Ç
    # -U testuser - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

    # docker-compose exec -T –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—É –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    # -T –æ—Ç–∫–ª—é—á–∞–µ—Ç TTY (–Ω—É–∂–Ω–æ –¥–ª—è —Å–∫—Ä–∏–ø—Ç–æ–≤)

    echo -e "${BLUE}–í—ã–ø–æ–ª–Ω—è–µ–º: docker-compose exec -T postgres pg_isready${NC}"

    if docker-compose exec -T postgres pg_isready &> /dev/null; then
        print_ok "PostgreSQL: –ì–æ—Ç–æ–≤ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"
        mark_passed

        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ë–î
        local db_version=$(docker-compose exec -T postgres psql -U testuser -d testdb -t -c "SELECT version();" 2>/dev/null | head -1 | xargs)
        if [ -n "$db_version" ]; then
            print_info "–í–µ—Ä—Å–∏—è: $db_version"
        fi
    else
        print_fail "PostgreSQL: –ù–µ –≥–æ—Ç–æ–≤ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
        mark_failed

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–æ–≤ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        echo -e "${YELLOW}–ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤ postgres:${NC}"
        docker-compose logs --tail=10 postgres
    fi

    echo ""
}

# ============================================================================
# –§–£–ù–ö–¶–ò–Ø: HEALTH CHECK BACKEND API
# ============================================================================

check_backend() {
    echo -e "${CYAN}===========================================================${NC}"
    echo -e "${CYAN}  3. Health Check - Backend API${NC}"
    echo -e "${CYAN}===========================================================${NC}"
    echo ""

    increment_total

    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–∏—Å
    if [ -n "$SPECIFIC_SERVICE" ] && [ "$SPECIFIC_SERVICE" != "backend" ]; then
        print_info "–ü—Ä–æ–ø—É—â–µ–Ω–æ (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ $SPECIFIC_SERVICE)"
        echo ""
        return
    fi

    # curl - —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
    # -s - silent (–±–µ–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞)
    # -o /dev/null - –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞
    # -w "%{http_code}" - –≤—ã–≤–µ—Å—Ç–∏ —Ç–æ–ª—å–∫–æ HTTP –∫–æ–¥ –æ—Ç–≤–µ—Ç–∞
    # --max-time 5 - —Ç–∞–π–º–∞—É—Ç 5 —Å–µ–∫—É–Ω–¥

    echo -e "${BLUE}–í—ã–ø–æ–ª–Ω—è–µ–º: curl -s -o /dev/null -w \"%{http_code}\" $BACKEND_URL/${NC}"

    local http_code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 "$BACKEND_URL/" 2>/dev/null)

    # HTTP –∫–æ–¥—ã:
    # 200 = OK
    # 404 = Not Found (backend —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω)
    # 000 = —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ

    if [ "$http_code" = "200" ]; then
        print_ok "Backend API: –î–æ—Å—Ç—É–ø–µ–Ω (HTTP $http_code)"
        mark_passed

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º /docs —ç–Ω–¥–ø–æ–∏–Ω—Ç (Swagger UI)
        local docs_code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 "$BACKEND_URL/docs" 2>/dev/null)
        if [ "$docs_code" = "200" ]; then
            print_info "Swagger UI –¥–æ—Å—Ç—É–ø–µ–Ω: $BACKEND_URL/docs"
        fi
    elif [ "$http_code" = "000" ]; then
        print_fail "Backend API: –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω (—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ)"
        mark_failed

        echo -e "${YELLOW}–ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤ backend:${NC}"
        docker-compose logs --tail=10 backend
    else
        print_warning "Backend API: HTTP $http_code (–æ–∂–∏–¥–∞–ª—Å—è 200)"
        mark_failed
    fi

    echo ""
}

# ============================================================================
# –§–£–ù–ö–¶–ò–Ø: –ü–†–û–í–ï–†–ö–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –†–ï–°–£–†–°–û–í
# ============================================================================

check_resources() {
    echo -e "${CYAN}===========================================================${NC}"
    echo -e "${CYAN}  4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ (CPU / RAM)${NC}"
    echo -e "${CYAN}===========================================================${NC}"
    echo ""

    # docker stats - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏
    # --no-stream - –≤—ã–≤–µ—Å—Ç–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ (–±–µ–∑ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)
    # --format - –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞

    echo -e "${BLUE}–í—ã–ø–æ–ª–Ω—è–µ–º: docker stats --no-stream${NC}"
    echo ""

    # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–≤–æ–¥
    # {{.Name}} - –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    # {{.CPUPerc}} - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
    # {{.MemUsage}} - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
    # {{.MemPerc}} - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö

    docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}"

    echo ""
    print_info "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤ –∑–∞–≤–µ—Ä—à—ë–Ω"
    echo ""
}

# ============================================================================
# –§–£–ù–ö–¶–ò–Ø: –ê–ù–ê–õ–ò–ó –õ–û–ì–û–í –ù–ê –û–®–ò–ë–ö–ò
# ============================================================================

check_logs() {
    echo -e "${CYAN}===========================================================${NC}"
    echo -e "${CYAN}  5. –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫${NC}"
    echo -e "${CYAN}===========================================================${NC}"
    echo ""

    if [ "$QUICK_MODE" = true ]; then
        print_info "–ü—Ä–æ–ø—É—â–µ–Ω–æ (–≤–∫–ª—é—á—ë–Ω –±—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º --quick)"
        echo ""
        return
    fi

    increment_total

    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ª–æ–≥–∏ –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
    # docker-compose logs --tail=N SERVICE - –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤
    # grep -i error - –ø–æ–∏—Å–∫ —Å–ª–æ–≤–∞ "error" (—Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ)
    # -i = case insensitive

    local services=("backend" "postgres")
    local total_errors=0

    for service in "${services[@]}"; do
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–∏—Å
        if [ -n "$SPECIFIC_SERVICE" ] && [ "$service" != "$SPECIFIC_SERVICE" ]; then
            continue
        fi

        echo -e "${CYAN}–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤: $service (–ø–æ—Å–ª–µ–¥–Ω–∏–µ $LOG_LINES —Å—Ç—Ä–æ–∫)${NC}"

        # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
        # grep -c - –ø–æ–¥—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
        # || true - —á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞—Ç—å –µ—Å–ª–∏ –æ—à–∏–±–æ–∫ –Ω–µ—Ç (grep –≤–µ—Ä–Ω—ë—Ç 1)
        local error_count=$(docker-compose logs --tail=$LOG_LINES "$service" 2>/dev/null | grep -ci "error" || true)

        if [ "$error_count" -eq 0 ]; then
            print_ok "$service: –û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
        else
            print_warning "$service: –ù–∞–π–¥–µ–Ω–æ –æ—à–∏–±–æ–∫: $error_count"
            ((total_errors += error_count))

            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 5 –æ—à–∏–±–æ–∫ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            echo -e "${YELLOW}–ü–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫ —Å –æ—à–∏–±–∫–∞–º–∏:${NC}"
            docker-compose logs --tail=$LOG_LINES "$service" 2>/dev/null | grep -i "error" | head -5
            echo ""
        fi
    done

    echo ""

    if [ $total_errors -eq 0 ]; then
        print_ok "–ò—Ç–æ–≥–æ: –û—à–∏–±–æ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ"
        mark_passed
    else
        print_warning "–ò—Ç–æ–≥–æ: –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ $total_errors —É–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö"
        print_info "–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ù–µ –≤—Å–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è 'error' —è–≤–ª—è—é—Ç—Å—è –∫—Ä–∏—Ç–∏—á–Ω—ã–º–∏"
        mark_failed
    fi

    echo ""
}

# ============================================================================
# –§–£–ù–ö–¶–ò–Ø: –ò–¢–û–ì–û–í–´–ô –û–¢–ß–Å–¢
# ============================================================================

show_summary() {
    echo -e "${CYAN}===========================================================${NC}"
    echo -e "${CYAN}  –ò–¢–û–ì–û–í–´–ô –û–¢–ß–Å–¢${NC}"
    echo -e "${CYAN}===========================================================${NC}"
    echo ""

    # –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
    local success_percent=0
    if [ $TOTAL_CHECKS -gt 0 ]; then
        success_percent=$((PASSED_CHECKS * 100 / TOTAL_CHECKS))
    fi

    echo -e "${BLUE}–í—Å–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–æ–∫:       $TOTAL_CHECKS${NC}"
    echo -e "${GREEN}–£—Å–ø–µ—à–Ω—ã—Ö:             $PASSED_CHECKS${NC}"
    echo -e "${RED}–ü—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö:          $FAILED_CHECKS${NC}"
    echo -e "${CYAN}–ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞:       $success_percent%${NC}"
    echo ""

    # –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
    if [ $FAILED_CHECKS -eq 0 ]; then
        echo -e "${GREEN}===========================================================${NC}"
        echo -e "${GREEN}  ‚úì –í–°–ï –ü–†–û–í–ï–†–ö–ò –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û${NC}"
        echo -e "${GREEN}===========================================================${NC}"
        exit 0
    else
        echo -e "${RED}===========================================================${NC}"
        echo -e "${RED}  ‚úó –û–ë–ù–ê–†–£–ñ–ï–ù–´ –ü–†–û–ë–õ–ï–ú–´${NC}"
        echo -e "${RED}===========================================================${NC}"
        echo -e "${YELLOW}–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:${NC}"
        echo "  1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤: docker-compose logs SERVICE"
        echo "  2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã: docker-compose restart SERVICE"
        echo "  3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ docker-compose.yml"
        echo ""
        exit 1
    fi
}

# ============================================================================
# –ü–ê–†–°–ò–ù–ì –ê–†–ì–£–ú–ï–ù–¢–û–í –ö–û–ú–ê–ù–î–ù–û–ô –°–¢–†–û–ö–ò
# ============================================================================

for arg in "$@"; do
    case $arg in
        --quick)
            QUICK_MODE=true
            ;;
        --service=*)
            SPECIFIC_SERVICE="${arg#--service=}"
            ;;
        --logs=*)
            LOG_LINES="${arg#--logs=}"
            ;;
        --help|-h)
            show_usage
            exit 0
            ;;
        *)
            echo -e "${RED}–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä: $arg${NC}"
            echo ""
            show_usage
            exit 1
            ;;
    esac
done

# ============================================================================
# –í–ê–õ–ò–î–ê–¶–ò–Ø –ü–ê–†–ê–ú–ï–¢–†–û–í
# ============================================================================

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ LOG_LINES - —ç—Ç–æ —á–∏—Å–ª–æ
if ! [[ $LOG_LINES =~ ^[0-9]+$ ]]; then
    echo -e "${RED}–û—à–∏–±–∫–∞: --logs –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º${NC}"
    exit 1
fi

# ============================================================================
# –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê
# ============================================================================

# –ü–µ—á–∞—Ç–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
echo ""
echo -e "${CYAN}‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì${NC}"
echo -e "${CYAN}‚îÉ  üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Docker —Å–µ—Ä–≤–∏—Å–æ–≤ - DockerKube –ø—Ä–æ–µ–∫—Ç    ‚îÉ${NC}"
echo -e "${CYAN}‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ${NC}"
echo ""
echo -e "${BLUE}–î–∞—Ç–∞ –∑–∞–ø—É—Å–∫–∞: $(date '+%Y-%m-%d %H:%M:%S')${NC}"
if [ "$QUICK_MODE" = true ]; then
    echo -e "${BLUE}–†–µ–∂–∏–º: –ë—ã—Å—Ç—Ä—ã–π (–±–µ–∑ –∞–Ω–∞–ª–∏–∑–∞ –ª–æ–≥–æ–≤)${NC}"
fi
if [ -n "$SPECIFIC_SERVICE" ]; then
    echo -e "${BLUE}–°–µ—Ä–≤–∏—Å: $SPECIFIC_SERVICE${NC}"
fi
echo ""

# –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏
check_dependencies
check_containers
check_postgres
check_backend
check_resources
check_logs

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç
show_summary
