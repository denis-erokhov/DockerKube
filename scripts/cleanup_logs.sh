#!/bin/bash
#
# cleanup_logs.sh - Автоматическая очистка старых логов
#
# Описание:
#   Удаляет лог-файлы старше заданного количества дней.
#   Поддерживает режим dry-run для безопасной проверки.
#   Ищет файлы *.log и *.txt в текущей директории и поддиректориях.
#
# Автор: Denis E.
# Дата: 2025-12-23
# Версия: 1.0
#
# Использование:
#   ./cleanup_logs.sh                    # Удалит *.log старше 7 дней
#   ./cleanup_logs.sh --dry-run          # Покажет что будет удалено
#   ./cleanup_logs.sh --days=14          # Удалит файлы старше 14 дней
#   ./cleanup_logs.sh --days=30 --dry-run  # Комбинация параметров
#   ./cleanup_logs.sh --help             # Показать справку
#

# ============================================================================
# ЦВЕТОВЫЕ КОДЫ ДЛЯ ТЕРМИНАЛА
# ============================================================================
# Используем ANSI escape codes для цветного вывода
# \033[ - начало escape последовательности
# 0m - сброс всех атрибутов
# 1; - жирный шрифт (bold)
# 31m, 32m, 33m, 36m - коды цветов (red, green, yellow, cyan)

RED='\033[0;31m'      # Красный - для ошибок
GREEN='\033[0;32m'    # Зелёный - для успешных операций
YELLOW='\033[1;33m'   # Жёлтый - для предупреждений
CYAN='\033[0;36m'     # Голубой - для информации
NC='\033[0m'          # No Color - сброс цвета

# ============================================================================
# ПЕРЕМЕННЫЕ ПО УМОЛЧАНИЮ
# ============================================================================

DAYS=7                # Количество дней (файлы старше этого срока будут удалены)
DRY_RUN=true          # Режим dry-run по умолчанию (true = показать, false = удалить)
LOG_PATTERN="*.log"   # Паттерн поиска файлов (можно изменить на *.txt и т.д.)
SEARCH_DIR="logs"     # Директория для поиска (по умолчанию: папка logs/)

# ============================================================================
# ФУНКЦИЯ: ПОКАЗАТЬ СПРАВКУ
# ============================================================================

show_usage() {
    echo -e "${CYAN}===========================================================${NC}"
    echo -e "${CYAN}  cleanup_logs.sh - Очистка старых лог-файлов${NC}"
    echo -e "${CYAN}===========================================================${NC}"
    echo ""
    echo "Использование: $0 [OPTIONS]"
    echo ""
    echo "Опции:"
    echo "  --days=N         Удалить файлы старше N дней (по умолчанию: 7)"
    echo "  --dry-run        Показать файлы без фактического удаления (ПО УМОЛЧАНИЮ)"
    echo "  --force          Реально удалить файлы (отключить dry-run режим)"
    echo "  --pattern=MASK   Паттерн поиска (по умолчанию: *.log)"
    echo "  --dir=PATH       Директория поиска (по умолчанию: logs/)"
    echo "  --help           Показать эту справку"
    echo ""
    echo "Примеры:"
    echo "  $0                            # Показать *.log старше 7 дней (dry-run)"
    echo "  $0 --days=14                  # Показать *.log старше 14 дней"
    echo "  $0 --days=14 --force          # РЕАЛЬНО удалить *.log старше 14 дней"
    echo "  $0 --pattern='*.txt' --days=30 --force  # Удалить *.txt старше 30 дней"
    echo ""
}

# ============================================================================
# ФУНКЦИЯ: ОЧИСТКА ЛОГОВ
# ============================================================================

cleanup_logs() {
    local days=$1
    local dry_run=$2
    local pattern=$3
    local search_dir=$4

    echo -e "${CYAN}===========================================================${NC}"
    echo -e "${CYAN}  Запуск очистки логов${NC}"
    echo -e "${CYAN}===========================================================${NC}"
    echo ""
    echo -e "${YELLOW}Параметры поиска:${NC}"
    echo "  - Директория: $search_dir"
    echo "  - Паттерн: $pattern"
    echo "  - Старше: $days дней"
    echo "  - Режим: $([ "$dry_run" = true ] && echo 'DRY-RUN (без удаления)' || echo 'УДАЛЕНИЕ')"
    echo ""

    # Команда find для поиска файлов:
    # -name "$pattern" - искать файлы по паттерну (например *.log)
    # -type f - искать только файлы (не директории)
    # -mtime +$days - файлы модифицированные более чем $days дней назад
    #   +7 означает "строго больше 7 дней" (файлы старше 7 дней)
    #   7 означает "точно 7 дней назад"
    #   -7 означает "менее 7 дней назад"

    # Подсчитываем количество найденных файлов
    local count=$(find "$search_dir" -name "$pattern" -type f -mtime +$days 2>/dev/null | wc -l)

    # 2>/dev/null - перенаправляем stderr в /dev/null (игнорируем ошибки доступа)
    # wc -l - подсчитываем количество строк (= количество файлов)

    if [ $count -eq 0 ]; then
        echo -e "${GREEN}✓ Файлов для удаления не найдено${NC}"
        return 0
    fi

    echo -e "${YELLOW}Найдено файлов: $count${NC}"
    echo ""

    # Показываем список файлов с деталями
    echo -e "${CYAN}Список файлов:${NC}"
    # ls -lh - подробный список с человекочитаемыми размерами
    # -h (human-readable) - показывает размеры в K, M, G вместо байтов
    find "$search_dir" -name "$pattern" -type f -mtime +$days -exec ls -lh {} \; 2>/dev/null
    echo ""

    # Подсчитываем общий размер файлов
    # -exec du -ch {} + - выполнить du для каждого найденного файла
    # du -c - показать общий итог (total)
    # -h - human-readable размеры
    # tail -1 - взять последнюю строку (это будет "total")
    # awk '{print $1}' - взять первую колонку (размер)
    local total_size=$(find "$search_dir" -name "$pattern" -type f -mtime +$days -exec du -ch {} + 2>/dev/null | tail -1 | awk '{print $1}')
    echo -e "${YELLOW}Общий размер: $total_size${NC}"
    echo ""

    if [ "$dry_run" = true ]; then
        echo -e "${GREEN}===========================================================${NC}"
        echo -e "${GREEN}  DRY-RUN режим - файлы НЕ удалены${NC}"
        echo -e "${GREEN}===========================================================${NC}"
        echo -e "${CYAN}Подсказка: Запустите с флагом --force для фактического удаления${NC}"
    else
        # Запрашиваем подтверждение у пользователя
        echo -e "${RED}ВНИМАНИЕ: Эти файлы будут УДАЛЕНЫ БЕЗВОЗВРАТНО!${NC}"
        echo -n -e "${YELLOW}Продолжить? [y/N]: ${NC}"
        read -r confirmation

        # Проверяем ответ пользователя
        # =~ - оператор regex matching в bash
        # ^[Yy]$ - строка начинается с Y или y и сразу заканчивается
        if [[ $confirmation =~ ^[Yy]$ ]]; then
            echo ""
            echo -e "${CYAN}Удаление файлов...${NC}"

            # Удаляем файлы
            # -delete - удалить найденные файлы
            # Альтернатива: -exec rm -f {} \;
            find "$search_dir" -name "$pattern" -type f -mtime +$days -delete 2>/dev/null

            # Проверяем код возврата последней команды
            # $? - код возврата последней команды
            # 0 - успех, не 0 - ошибка
            if [ $? -eq 0 ]; then
                echo ""
                echo -e "${GREEN}===========================================================${NC}"
                echo -e "${GREEN}  ✓ Успешно удалено файлов: $count ($total_size)${NC}"
                echo -e "${GREEN}===========================================================${NC}"
            else
                echo ""
                echo -e "${RED}===========================================================${NC}"
                echo -e "${RED}  ✗ Ошибка при удалении файлов${NC}"
                echo -e "${RED}===========================================================${NC}"
                return 1
            fi
        else
            echo ""
            echo -e "${YELLOW}Отменено пользователем${NC}"
            return 0
        fi
    fi
}

# ============================================================================
# ПАРСИНГ АРГУМЕНТОВ КОМАНДНОЙ СТРОКИ
# ============================================================================

# Цикл по всем переданным аргументам
# $@ - все аргументы командной строки
# for arg in "$@" - перебираем каждый аргумент

for arg in "$@"; do
    case $arg in
        --days=*)
            # ${arg#--days=} - удаляет префикс --days= из строки
            # Пример: --days=14 → 14
            DAYS="${arg#--days=}"
            ;;
        --dry-run)
            DRY_RUN=true
            ;;
        --force)
            DRY_RUN=false
            ;;
        --pattern=*)
            LOG_PATTERN="${arg#--pattern=}"
            ;;
        --dir=*)
            SEARCH_DIR="${arg#--dir=}"
            ;;
        --help|-h)
            show_usage
            exit 0
            ;;
        *)
            echo -e "${RED}Неизвестный параметр: $arg${NC}"
            echo ""
            show_usage
            exit 1
            ;;
    esac
done

# ============================================================================
# ВАЛИДАЦИЯ ПАРАМЕТРОВ
# ============================================================================

# Проверяем что DAYS - это число
# =~ ^[0-9]+$ - regex: строка состоит только из цифр
if ! [[ $DAYS =~ ^[0-9]+$ ]]; then
    echo -e "${RED}Ошибка: --days должен быть числом${NC}"
    exit 1
fi

# Проверяем что директория существует
# -d - проверка на существование директории
if [ ! -d "$SEARCH_DIR" ]; then
    echo -e "${RED}Ошибка: Директория '$SEARCH_DIR' не существует${NC}"
    exit 1
fi

# ============================================================================
# ОСНОВНАЯ ЛОГИКА
# ============================================================================

# Запускаем функцию очистки с параметрами
cleanup_logs "$DAYS" "$DRY_RUN" "$LOG_PATTERN" "$SEARCH_DIR"

# Сохраняем код возврата функции
exit_code=$?

# Возвращаем код возврата
# 0 - успех, 1 - ошибка
exit $exit_code
